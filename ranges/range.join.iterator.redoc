[section#range.join.iterator
    [:en] Class template [`join_view::[*iterator]]
    [:zh_CN] 类模板 [`join_view::[*iterator]]
]

[%@lib join_view::iterator]
[codeblock:synopsis]
namespace std::ranges {
  template<[[redoc("`:c>")]]input_range V>
    requires view<V> && [[redoc("`:c>")]]input_range<range_reference_t<V>> &&
             (is_reference_v<range_reference_t<V>> ||
              view<range_value_t<V>>)
  template<bool Const>
  struct join_view<V>::[[redoc("*>")]]iterator {
  private:
    using [[redoc("*>")]]Parent = [[redoc("*>")]]maybe-const<Const, join_view>;               // [=expos]
    using [[redoc("*>")]]Base   = [[redoc("*>")]]maybe-const<Const, V>;                       // [=expos]

    static constexpr bool [[redoc("*>")]]ref-is-glvalue =                      // [=expos]
      is_reference_v<range_reference_t<[[redoc("*>")]]Base>>;

    iterator_t<[[redoc("*>")]]Base> [[redoc("*>")]]outer_ = iterator_t<[[redoc("*>")]]Base>();               // [=expos]
    iterator_t<range_reference_t<[[redoc("*>")]]Base>> [[redoc("*>")]]inner_ =                // [=expos]
      iterator_t<range_reference_t<[[redoc("*>")]]Base>>();
    [[redoc("*>")]]Parent* [[redoc("*>")]]parent_ = nullptr;                                  // [=expos]

    constexpr void [[redoc("*>")]]satisfy();                                   // [=expos]
  public:
    using iterator_concept  = [[redoc("[=seebelow]")]];
    using iterator_category = [[redoc("[=seebelow]")]];
    using value_type        = range_value_t<range_reference_t<[[redoc("*>")]]Base>>;
    using difference_type   = [[redoc("[=seebelow]")]];

    [[redoc("*>")]]iterator() = default;
    constexpr [[redoc("*>")]]iterator([[redoc("*>")]]Parent& parent, iterator_t<[[redoc("*>")]]Base> outer);
    constexpr [[redoc("*>")]]iterator([[redoc("*>")]]iterator<!Const> i)
      requires Const &&
               [[redoc("`:c>")]]convertible_to<iterator_t<V>, iterator_t<[[redoc("*>")]]Base>> &&
               [[redoc("`:c>")]]convertible_to<iterator_t<[[redoc("*>")]]InnerRng>,
                              iterator_t<range_reference_t<[[redoc("*>")]]Base>>>;

    constexpr decltype(auto) operator*() const { return *[[redoc("*>")]]inner_; }

    constexpr iterator_t<[[redoc("*>")]]Base> operator->() const
      requires [[redoc("*:c>")]]has-arrow<iterator_t<[[redoc("*>")]]Base>> && [[redoc("`:c>")]]copyable<iterator_t<[[redoc("*>")]]Base>>;

    constexpr [[redoc("*>")]]iterator& operator++();
    constexpr void operator++(int);
    constexpr [[redoc("*>")]]iterator operator++(int)
      requires [[redoc("*>")]]ref-is-glvalue && [[redoc("`:c>")]]forward_range<[[redoc("*>")]]Base> &&
               [[redoc("`:c>")]]forward_range<range_reference_t<[[redoc("*>")]]Base>>;

    constexpr [[redoc("*>")]]iterator& operator--()
      requires [[redoc("*>")]]ref-is-glvalue && [[redoc("`:c>")]]bidirectional_range<[[redoc("*>")]]Base> &&
               [[redoc("`:c>")]]bidirectional_range<range_reference_t<[[redoc("*>")]]Base>> &&
               common_range<range_reference_t<[[redoc("*>")]]Base>>;

    constexpr [[redoc("*>")]]iterator operator--(int)
      requires [[redoc("*>")]]ref-is-glvalue && [[redoc("`:c>")]]bidirectional_range<[[redoc("*>")]]Base> &&
               [[redoc("`:c>")]]bidirectional_range<range_reference_t<[[redoc("*>")]]Base>> &&
               common_range<range_reference_t<[[redoc("*>")]]Base>>;

    friend constexpr bool operator==(const [[redoc("*>")]]iterator& x, const [[redoc("*>")]]iterator& y)
      requires [[redoc("*>")]]ref-is-glvalue && [[redoc("`:c>")]]equality_comparable<iterator_t<[[redoc("*>")]]Base>> &&
               [[redoc("`:c>")]]equality_comparable<iterator_t<range_reference_t<[[redoc("*>")]]Base>>>;

    friend constexpr decltype(auto) iter_move(const [[redoc("*>")]]iterator& i)
    noexcept(noexcept(ranges::iter_move(i.[[redoc("*>")]]inner_))) {
      return ranges::iter_move(i.[[redoc("*>")]]inner_);
    }

    friend constexpr void iter_swap(const [[redoc("*>")]]iterator& x, const [[redoc("*>")]]iterator& y)
      noexcept(noexcept(ranges::iter_swap(x.[[redoc("*>")]]inner_, y.[[redoc("*>")]]inner_)));
  };
}
[codeblock:end]

[para]
[:en] [`iterator::iterator_concept] is defined as follows:
[:zh_CN] [`iterator::iterator_concept] 的定义如下：

[list]
[item]
[:en] If [*ref-is-glvalue] is [`true] and [*Base] and
[`range_reference_t<[*Base]>] each model [`:c bidirectional_range], then
[`iterator_concept] denotes [`bidirectional_iterator_tag].
[:zh_CN] 若 [*ref-is-glvalue] 为 [`true] 且 [*Base] 和
[`range_reference_t<[*Base]>] 均构成 [`:c bidirectional_range]，则
[`iterator_concept] 代表 [`bidirectional_iterator_tag]。

[item]
[:en] Otherwise, if [*ref-is-glvalue] is [`true] and [*Base] and
[`range_reference_t<[*Base]>] each model [`:c forward_range], then
[`iterator_concept] denotes [`forward_iterator_tag].
[:zh_CN] 否则，若 [*ref-is-glvalue] 为 [`true] 且 [*Base] 和
[`range_reference_t<[*Base]>] 均构成 [`:c forward_range]，则 [`iterator_concept]
代表 [`forward_iterator_tag]。

[item]
[:en] Otherwise, [`iterator_concept] denotes [`input_iterator_tag].
[:zh_CN] 否则，[`iterator_concept] 代表 [`input_iterator_tag]。
[list:end]

[para]
[:en] [`iterator::iterator_category] is defined as follows:
[:zh_CN] [`iterator::iterator_category] 的定义如下：

[list]
[item]
[:en] Let [^OUTERC] denote the
[`iterator_traits<iterator_t<[*Base]>>::iterator_category], and let [^INNERC]
denote
[`iterator_traits<iterator_t<range_reference_t<[*Base]>>>::iterator_category].
[:zh_CN] 令 [^OUTERC] 代表
[`iterator_traits<iterator_t<[*Base]>>::iterator_category]，并令 [^INNERC] 代表
[`iterator_traits<iterator_t<range_reference_t<[*Base]>>>::iterator_category]。

[item]
[:en] If [*ref-is-glvalue] is [`true] and [^OUTERC] and [^INNERC] each model
[`[`:c derived_from]<bidirectional_iterator_tag>], [`iterator_category] denotes
[`bidirectional_iterator_tag].
[:zh_CN] 若 [*ref-is-glvalue] 为 [`true] 且 [^OUTERC] 和 [^INNERC] 均构成
[`[`:c derived_from]<bidirectional_iterator_tag>]，则 [`iterator_category] 代表
[`bidirectional_iterator_tag]。

[item]
[:en] Otherwise, if [*ref-is-glvalue] is [`true] and [^OUTERC] and [^INNERC]
each model [`[`:c derived_from]<forward_iterator_tag>], [`iterator_category]
denotes [`forward_iterator_tag].
[:zh_CN] 否则，若 [*ref-is-glvalue] 为 [`true] 且 [^OUTERC] 和 [^INNERC] 均构成
[`[`:c derived_from]<forward_iterator_tag>]，则 [`iterator_category] 代表
[`forward_iterator_tag]。

[item]
[:en] Otherwise, if [^OUTERC] and [^INNERC] each model
[`[`:c derived_from]<input_iterator_tag>], [`iterator_category] denotes
[`input_iterator_tag].
[:zh_CN] 否则，若 [^OUTERC] 和 [^INNERC] 均构成
[`[`:c derived_from]<input_iterator_tagg>]，则 [`iterator_category] 代表
[`input_iterator_tag]。

[item]
[:en] Otherwise, [`iterator_category] denotes [`output_iterator_tag].
[:zh_CN] 否则，[`iterator_category] 代表 [`output_iterator_tag]。
[list:end]

[para]
[:en] [`iterator::difference_type] denotes the type:
[:zh_CN] [`iterator::difference_type] 代表类型：
[codeblock]
common_type_t<
  range_difference_t<[[redoc("*>")]]Base>,
  range_difference_t<range_reference_t<[[redoc("*>")]]Base>>>
[codeblock:end]

[para]
[:en] [`join_view] iterators use the [*satisfy] function to skip over empty
inner ranges.
[:zh_CN] [`join_view] 迭代器使用 [*satisfy] 函数以跳过空的内部范围。

[codeblock:declaration]
constexpr void [[redoc("*>")]]satisfy();       // [=expos]
[codeblock:end]

[div:description]
[para:effects]
[:en] Equivalent to:
[:zh_CN] 等价于：
[codeblock]
auto update_inner = [this](range_reference_t<[[redoc("*>")]]Base> x) -> auto& {
  if constexpr ([[redoc("*>")]]ref-is-glvalue) // [:en] [`x] is a reference \
                                                  [:zh_CN] [`x] 是引用
    return x;
  else
    return ([[redoc("*>")]]parent_->[[redoc("*>")]]inner_ = views::all(std::move(x)));
};

for (; [[redoc("*>")]]outer_ != ranges::end([[redoc("*>")]]parent_->[[redoc("*>")]]base_); ++[[redoc("*>")]]outer_) {
  auto& inner = update_inner(*[[redoc("*>")]]outer_);
  [[redoc("*>")]]inner_ = ranges::begin(inner);
  if ([[redoc("*>")]]inner_ != ranges::end(inner))
    return;
}
if constexpr ([[redoc("*>")]]ref-is-glvalue)
  [[redoc("*>")]]inner_ = iterator_t<range_reference_t<[[redoc("*>")]]Base>>();
[codeblock:end]
[div:end]

[%@lib@ctor join_view::iterator]
[codeblock:declaration]
constexpr [[redoc("*>")]]iterator([[redoc("*>")]]Parent& parent, iterator_t<[[redoc("*>")]]Base> outer)
[codeblock:end]

[div:description]
[para:effects]
[:en] Initializes [*outer_] with [`std::move(outer)] and [*parent_] with
[`addressof(parent)]; then calls [`[*satisfy]()].
[:zh_CN] 以 [`std::move(outer)] 初始化 [*outer_] 并以 [`addressof(parent)]
初始化 [*parent_]；然后调用 [`[*satisfy]()]。
[div:end]

[%@lib@ctor join_view::iterator]
[codeblock:declaration]
constexpr [[redoc("*>")]]iterator([[redoc("*>")]]iterator<!Const> i)
  requires Const &&
           [[redoc("`:c>")]]convertible_to<iterator_t<V>, iterator_t<[[redoc("*>")]]Base>> &&
           [[redoc("`:c>")]]convertible_to<iterator_t<[[redoc("*>")]]InnerRng>,
                          iterator_t<range_reference_t<[[redoc("*>")]]Base>>>;
[codeblock:end]

[div:description]
[para:effects]
[:en] Initializes [*outer_] with [`std::move(i.[*outer_])], [*inner_] with
[`std::move(i.[*inner_])], and [*parent_] with [`i.[*parent_]].
[:zh_CN] 以 [`std::move(i.[*outer_])] 初始化 [*outer_]，以
[`std::move(i.[*inner_])] 初始化 [*inner_]，并以 [`i.[*parent_]] 初始化 [*parent_]。
[div:end]

[%@lib@member operator->[!join_view::iterator]]
[codeblock:declaration]
constexpr iterator_t<[[redoc("*>")]]Base> operator->() const
  requires [[redoc("*:c>")]]has-arrow<iterator_t<[[redoc("*>")]]Base>> && copyable<iterator_t<[[redoc("*>")]]Base>>;
[codeblock:end]

[div:description]
[para:effects]
[:en] Equivalent to [`return [*inner_];]
[:zh_CN] 等价于 [`return [*inner_];]
[div:end]

[%@lib@member operator++[!join_view::iterator]]
[codeblock:declaration]
constexpr [[redoc("*>")]]iterator& operator++();
[codeblock:end]

[div:description]
[para]
[:en] Let [`[^inner-range]] be:
[:zh_CN] 令 [`[^inner-range]] 为：
[list]
[item]
[:en] If [*ref-is-glvalue] is [`true], [`*[*outer_]].
[:zh_CN] 当 [*ref-is-glvalue] 为 [`true] 时，为 [`*[*outer_]]。
[item]
[:en] Otherwise, [`[*parent_]->[*inner_]].
[:zh_CN] 否则，为 [`[*parent_]->[*inner_]]。
[list:end]

[para:effects]
[:en] Equivalent to:
[:zh_CN] 等价于：
[codeblock]
auto&& inner_rng = [[redoc("^>")]]inner-range;
if (++[[redoc("*>")]]inner_ == ranges::end(inner_rng)) {
  ++[[redoc("*>")]]outer_;
  [[redoc("*>")]]satisfy();
}
return *this;
[codeblock:end]
[div:end]

[%@lib@member operator++[!join_view::iterator]]
[codeblock:declaration]
constexpr void operator++(int);
[codeblock:end]

[div:description]
[para:effects]
[:en] Equivalent to: [`++*this].
[:zh_CN] 等价于：[`++*this]。
[div:end]

[%@lib@member operator++[!join_view::iterator]]
[codeblock:declaration]
constexpr [[redoc("*>")]]iterator operator++(int)
  requires [[redoc("*>")]]ref-is-glvalue && [[redoc("`:c>")]]forward_range<[[redoc("*>")]]Base> &&
           [[redoc("`:c>")]]forward_range<range_reference_t<[[redoc("*>")]]Base>>;
[codeblock:end]

[div:description]
[para:effects]
[:en] Equivalent to:
[:zh_CN] 等价于：
[codeblock]
auto tmp = *this;
++*this;
return tmp;
[codeblock:end]
[div:end]

[%@lib@member operator--[!join_view::iterator]]
[codeblock:declaration]
constexpr [[redoc("*>")]]iterator& operator--()
  requires [[redoc("*>")]]ref-is-glvalue && [[redoc("`:c>")]]bidirectional_range<[[redoc("*>")]]Base> &&
           [[redoc("`:c>")]]bidirectional_range<range_reference_t<[[redoc("*>")]]Base>> &&
           common_range<range_reference_t<[[redoc("*>")]]Base>>;
[codeblock:end]

[div:description]
[para:effects]
[:en] Equivalent to:
[:zh_CN] 等价于：
[codeblock]
if ([[redoc("*>")]]outer_ == ranges::end([[redoc("*>")]]parent_->vbase_))
  [[redoc("*>")]]inner_ = ranges::end(*--[[redoc("*>")]]outer_);
while ([[redoc("*>")]]inner_ == ranges::begin(*[[redoc("*>")]]outer_))
  [[redoc("*>")]]inner_ = ranges::end(*--[[redoc("*>")]]outer_);
--[[redoc("*>")]]inner_;
return *this;
[codeblock:end]
[div:end]

[%@lib@member operator--[!join_view::iterator]]
[codeblock:declaration]
constexpr [[redoc("*>")]]iterator operator--(int)
  requires [[redoc("*>")]]ref-is-glvalue && [[redoc("`:c>")]]bidirectional_range<[[redoc("*>")]]Base> &&
           [[redoc("`:c>")]]bidirectional_range<range_reference_t<[[redoc("*>")]]Base>> &&
           common_range<range_reference_t<[[redoc("*>")]]Base>>;
[codeblock:end]

[div:description]
[para:effects]
[:en] Equivalent to:
[:zh_CN] 等价于：
[codeblock]
auto tmp = *this;
--*this;
return tmp;
[codeblock:end]
[div:end]

[%@lib@member operator==[!join_view::iterator]]
[codeblock:declaration]
friend constexpr bool operator==(const [[redoc("*>")]]iterator& x, const [[redoc("*>")]]iterator& y)
  requires [[redoc("*>")]]ref-is-glvalue && equality_comparable<iterator_t<[[redoc("*>")]]Base>> &&
           equality_comparable<iterator_t<range_reference_t<[[redoc("*>")]]Base>>>;
[codeblock:end]

[div:description]
[para:effects]
[:en] Equivalent to:
[`return x.[*outer_] == y.[*outer_] && x.[*inner_] == y.[*inner_];]
[:zh_CN] 等价于：
[`return x.[*outer_] == y.[*outer_] && x.[*inner_] == y.[*inner_];]
[div:end]

[%@lib@member iter_swap[!join_view::iterator]]
[codeblock:declaration]
friend constexpr void iter_swap(const [[redoc("*>")]]iterator& x, const [[redoc("*>")]]iterator& y)
  noexcept(noexcept(ranges::iter_swap(x.[[redoc("*>")]]inner_, y.[[redoc("*>")]]inner_)));
[codeblock:end]

[div:description]
[para:effects]
[:en] Equivalent to: [`return ranges::iter_swap(x.[*inner_], y.[*inner_]);]
[:zh_CN] 等价于：[`return ranges::iter_swap(x.[*inner_], y.[*inner_]);]
[div:end]
